<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML 노래 편집기 (텍스트)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: scroll; /* 스크롤바 항상 표시 */
        }
        /* 로드 버튼 비활성화 시 스타일 */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* 태그 삭제 버튼 */
        .tag-delete-btn {
            line-height: 1;
            padding: 2px 4px;
            font-weight: bold;
        }
        
        /* 노래 카드 호버 효과 */
        .card-hover-scale {
            transition-property: transform;
        }
        .card-hover-scale:hover {
            transform: scale(1.03);
        }

        /* Toast 알림 스타일 */
        #toast-message {
            position: fixed;
            bottom: -100px; /* 초기 위치 (숨김) */
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e; /* green-500 */
            color: white;
            padding: 12px 24px;
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            z-index: 50;
        }
        #toast-message.show {
            bottom: 20px;
            opacity: 1;
        }
        #toast-message.error {
            background-color: #ef4444; /* red-500 */
        }

        /* 필터 버튼 활성/비활성 스타일 */
        .filter-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: #ffffff;
        }
        .filter-btn.inactive {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
        }
        .filter-btn.inactive:hover {
            background-color: #4b5563; /* gray-600 */
        }
        /* 업보목록 특별 스타일 */
        .filter-btn[data-category="업보목록"].inactive {
             background-color: #c2410c; /* orange-700 */
             color: #fde68a; /* orange-200 */
        }
         .filter-btn[data-category="업보목록"].inactive:hover {
             background-color: #9a3412; /* orange-800 */
        }
        .filter-btn[data-category="업보목록"].active {
            background-color: #f97316; /* orange-500 */
            color: #ffffff;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4 md:p-8">

    <!-- Toast 알림 메시지용 div -->
    <div id="toast-message"></div>

    <div class="max-w-6xl mx-auto">
        
        <h1 class="text-3xl font-bold text-center text-white mb-6">HTML 노래 편집기</h1>

        <!-- 1. HTML 입력 섹션 -->
        <div id="input-section" class="mb-6">
            <label for="html-input" class="block text-sm font-medium text-gray-300 mb-1">1. 원본 HTML 코드 붙여넣기</label>
            <textarea id="html-input" rows="10" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="여기에 'allSongsData' 배열이 포함된 HTML 코드를 붙여넣으세요..."></textarea>
            
            <button id="load-btn" class="w-full mt-3 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-lg transition duration-200">
                HTML 로드
            </button>
            
            <button id="generate-btn" class="hidden w-full mt-3 bg-green-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
                HTML 코드 생성 및 복사
            </button>
            
            <p id="copy-message" class="text-sm font-medium text-center text-green-400 mt-3 h-5"></p>
            <p id="file-info" class="text-sm font-medium text-center mt-3 h-5"></p>
        </div>

        <!-- 2. 태그 생성 및 관리 섹션 (초기 숨김) -->
        <div id="tag-management-section" class="hidden p-6 bg-gray-800 rounded-xl shadow-lg mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">2. 태그 생성 및 관리</h2>
            <!-- [수정] 4열 그리드로 변경 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- 카테고리 관리 -->
                <div>
                    <h3 class="text-lg font-medium text-gray-200 mb-3">카테고리</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="category-tag-input" class="flex-1 w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="새 카테고리 입력...">
                        <button id="category-tag-add" data-type="category" class="tag-add-btn px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">추가</button>
                    </div>
                    <div id="category-manage-list" class="flex flex-wrap gap-2 p-3 bg-gray-700 rounded-md min-h-[40px]">
                        <!-- 태그 목록이 여기에 동적으로 생성됩니다 -->
                    </div>
                </div>

                <!-- 난이도 관리 -->
                <div>
                    <h3 class="text-lg font-medium text-gray-200 mb-3">난이도</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="difficulty-tag-input" class="flex-1 w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="새 난이도 입력...">
                        <button id="difficulty-tag-add" data-type="difficulty" class="tag-add-btn px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">추가</button>
                    </div>
                    <div id="difficulty-manage-list" class="flex flex-wrap gap-2 p-3 bg-gray-700 rounded-md min-h-[40px]">
                        <!-- 태그 목록이 여기에 동적으로 생성됩니다 -->
                    </div>
                </div>

                <!-- 가격 태그 관리 -->
                <div>
                    <h3 class="text-lg font-medium text-gray-200 mb-3">가격 태그</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="priceTag-tag-input" class="flex-1 w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="새 가격 태그 입력...">
                        <button id="priceTag-tag-add" data-type="priceTag" class="tag-add-btn px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">추가</button>
                    </div>
                    <div id="priceTag-manage-list" class="flex flex-wrap gap-2 p-3 bg-gray-700 rounded-md min-h-[40px]">
                        <!-- 태그 목록이 여기에 동적으로 생성됩니다 -->
                    </div>
                </div>

                <!-- [신규] 업보 태그 관리 -->
                <div>
                    <h3 class="text-lg font-medium text-gray-200 mb-3">업보 태그</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="upboType-tag-input" class="flex-1 w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="새 업보 태그 입력...">
                        <button id="upboType-tag-add" data-type="upboType" class="tag-add-btn px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">추가</button>
                    </div>
                    <div id="upboType-manage-list" class="flex flex-wrap gap-2 p-3 bg-gray-700 rounded-md min-h-[40px]">
                        <!-- 태그 목록이 여기에 동적으로 생성됩니다 -->
                    </div>
                </div>

            </div>
        </div>

        <!-- 3. 노래 등록하기 섹션 (초기 숨김) -->
        <div id="editor-section" class="hidden p-6 bg-gray-800 rounded-xl shadow-lg mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">3. 노래 등록하기</h2>
            
            <form id="song-form" class="space-y-4">
                <!-- "노래 등록하기" 컨테이너 -->
                <div class="p-4 bg-gray-700 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-200 mb-4">노래 등록하기</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 노래 제목 -->
                        <div>
                            <label for="song-title" class="block text-sm font-medium text-gray-300 mb-1">노래 제목</label>
                            <input type="text" id="song-title" data-key="title" class="song-input w-full px-3 py-2 bg-gray-600 border border-gray-500 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <!-- 아티스트 -->
                        <div>
                            <label for="song-artist" class="block text-sm font-medium text-gray-300 mb-1">아티스트</label>
                            <input type="text" id="song-artist" data-key="artist" class="song-input w-full px-3 py-2 bg-gray-600 border border-gray-500 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <!-- Key -->
                        <div>
                            <label for="song-key" class="block text-sm font-medium text-gray-300 mb-1">Key</label>
                            <input type="text" id="song-key" data-key="key" class="song-input w-full px-3 py-2 bg-gray-600 border border-gray-500 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <!-- BPM -->
                        <div>
                            <label for="song-bpm" class="block text-sm font-medium text-gray-300 mb-1">BPM</label>
                            <input type="text" id="song-bpm" data-key="bpm" class="song-input w-full px-3 py-2 bg-gray-600 border border-gray-500 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- 카테고리 -->
                        <div>
                            <label for="song-category" class="block text-sm font-medium text-gray-300 mb-1">카테고리</label>
                            <select id="song-category" data-key="category" class="song-input w-full px-3 py-2 bg-gray-600 border border-gray-500 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">선택하세요...</option>
                                <!-- 옵션이 동적으로 채워집니다 -->
                            </select>
                        </div>
                        <!-- 난이도 -->
                        <div>
                            <label for="song-difficulty" class="block text-sm font-medium text-gray-300 mb-1">난이도</label>
                            <select id="song-difficulty" data-key="difficulty" class="song-input w-full px-3 py-2 bg-gray-600 border border-gray-500 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">선택하세요...</option>
                                <!-- 옵션이 동적으로 채워집니다 -->
                            </select>
                        </div>
                        <!-- 가격 태그 -->
                        <div>
                            <label for="song-priceTag" class="block text-sm font-medium text-gray-300 mb-1">가격 태그</label>
                            <select id="song-priceTag" data-key="cheeseTag" class="song-input w-full px-3 py-2 bg-gray-600 border border-gray-500 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">선택하세요...</option>
                                <!-- 옵션이 동적으로 채워집니다 -->
                            </select>
                        </div>

                        <!-- [신규] 업보 태그 (초기 숨김) -->
                        <div id="upboType-container" class="hidden">
                            <label for="song-upboType" class="block text-sm font-medium text-gray-300 mb-1">업보 태그</label>
                            <select id="song-upboType" data-key="upboType" class="song-input w-full px-3 py-2 bg-gray-600 border border-gray-500 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">선택하세요...</option>
                                <!-- 옵션이 동적으로 채워집니다 -->
                            </select>
                        </div>
                        
                        <!-- 노래 추가 버튼 -->
                        <button id="addBtn" type="submit" class="md:col-span-2 w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                            노래 추가
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 4. 전체 노래 목록 섹션 (초기 숨김) -->
        <div id="song-list-section" class="hidden p-6 bg-gray-800 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-white mb-4">4. 전체 노래 목록</h2>
            
            <!-- 카테고리 필터 버튼 컨테이너 -->
            <div id="filter-buttons-container" class="flex flex-wrap gap-2 mb-4">
                <!-- 필터 버튼이 여기에 동적으로 생성됩니다. -->
            </div>

            <div id="songList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- 노래 카드가 여기에 동적으로 생성됩니다. -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 섹션 1: HTML 입력 ---
            const htmlInput = document.getElementById('html-input');
            const loadBtn = document.getElementById('load-btn');
            const fileInfo = document.getElementById('file-info');
            const generateBtn = document.getElementById('generate-btn');
            const copyMessage = document.getElementById('copy-message');

            // --- 섹션 2: 태그 관리 ---
            const tagManagementSection = document.getElementById('tag-management-section');
            const tagAddButtons = document.querySelectorAll('.tag-add-btn');
            const tagManagementLists = {
                category: document.getElementById('category-manage-list'),
                difficulty: document.getElementById('difficulty-manage-list'),
                priceTag: document.getElementById('priceTag-manage-list'),
                upboType: document.getElementById('upboType-manage-list') // [신규]
            };
            const tagInputs = {
                category: document.getElementById('category-tag-input'),
                difficulty: document.getElementById('difficulty-tag-input'),
                priceTag: document.getElementById('priceTag-tag-input'),
                upboType: document.getElementById('upboType-tag-input') // [신규]
            };

            // --- 섹션 3: 노래 등록 ---
            const editorSection = document.getElementById('editor-section');
            const songForm = document.getElementById('song-form');
            const songInputs = document.querySelectorAll('.song-input');
            const addBtn = document.getElementById('addBtn');
            const formSelects = {
                category: document.getElementById('song-category'),
                difficulty: document.getElementById('song-difficulty'),
                priceTag: document.getElementById('song-priceTag'),
                upboType: document.getElementById('song-upboType') // [신규]
            };
            const upboTypeContainer = document.getElementById('upboType-container'); // [신규]

            // --- 섹션 4: 노래 목록 ---
            const songListSection = document.getElementById('song-list-section');
            const songList = document.getElementById('songList');
            const filterButtonsContainer = document.getElementById('filter-buttons-container');

            // --- Toast 알림 ---
            const toastMessage = document.getElementById('toast-message');

            // --- 상태 변수 ---
            let originalHtmlText = '';
            let existingSongs = [];
            let newSongs = [];
            let originalMatch = null;
            let songDataRegex = null;
            let currentCategory = '전체'; // 현재 선택된 필터 카테고리
            const PROTECTED_CATEGORY = '업보목록'; // 보호된 카테고리

            // 태그 옵션 상태
            let tagOptions = {
                category: ['남자 아이돌', '여자 아이돌', '업보목록', '제이팝', '팝송', '인디/힙합'],
                difficulty: ['1절', '2절', '어려움'],
                priceTag: ['5,000치즈', '10,000치즈'],
                upboType: ['녹음', '애교곡', '노래 연습'] // [신규] (기본값)
            };

            // --- 헬퍼 함수 ---

            /**
             * Toast 알림을 표시합니다.
             * @param {string} message - 표시할 메시지
             * @param {boolean} [isError=false] - 오류 메시지 여부 (빨간색)
             */
            function showToast(message, isError = false) {
                toastMessage.textContent = message;
                toastMessage.className = isError ? 'show error' : 'show';
                
                setTimeout(() => {
                    toastMessage.className = '';
                }, 2500); // 2.5초 후 사라짐
            }

            /**
             * 텍스트를 클립보드에 복사합니다.
             * @param {string} text - 복사할 텍스트
             */
            function copyToClipboard(text) {
                // execCommand는 iframe 환경에서 더 안정적으로 작동할 수 있습니다.
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = text;
                tempTextarea.style.position = 'fixed';
                tempTextarea.style.top = '-9999px';
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    document.execCommand('copy');
                    showToast(`'${text}' 복사 완료!`);
                } catch (err) {
                    console.error('클립보드 복사 실패:', err);
                    showToast('복사에 실패했습니다.', true);
                }
                document.body.removeChild(tempTextarea);
            }

            /**
             * 노래 목록을 카드 형태로 렌더링합니다.
             * @param {Array} songsToRender - 렌더링할 노래 객체 배열
             */
            const renderSongs = (songsToRender) => {
                songList.innerHTML = ''; // 기존 목록을 비웁니다.
                if (songsToRender.length === 0) {
                    songList.innerHTML = '<p class="text-center text-gray-500 col-span-full">표시할 노래가 없습니다.</p>';
                    return;
                }
                
                songsToRender.forEach(song => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-700 p-4 rounded-xl shadow-md transform card-hover-scale transition-transform duration-300 cursor-pointer';
                    
                    let tagsHtml = '';
                    if (song.category === PROTECTED_CATEGORY) {
                        // '업보목록' 카테고리
                        tagsHtml = `<span class="bg-gray-800 text-purple-400 text-xs font-semibold px-2 py-1 rounded-full">${song.upboType || '업보'}</span>`;
                    } else {
                        // 그 외 카테고리
                        tagsHtml = `
                            <span class="bg-gray-800 text-gray-400 text-xs font-semibold px-2 py-1 rounded-full">${song.category}</span>
                            ${song.difficulty ? `<span class="bg-gray-800 text-blue-400 text-xs font-semibold px-2 py-1 rounded-full">${song.difficulty}</span>` : ''}
                            ${song.cheeseTag ? `<span class="bg-gray-800 text-yellow-400 text-xs font-semibold px-2 py-1 rounded-full">${song.cheeseTag}</span>` : ''}
                        `;
                    }

                    card.innerHTML = `
                        <div class="flex items-baseline">
                            <h3 class="text-lg font-semibold text-gray-50 truncate">${song.title}</h3>
                            <p class="text-gray-400 text-sm truncate ml-2">${song.artist}</p>
                        </div>
                        <div class="flex items-center justify-between mt-1">
                            <div class="flex space-x-2 overflow-x-auto">
                                ${tagsHtml}
                            </div>
                            <div class="flex space-x-2 text-gray-500 text-xs flex-shrink-0 ml-2">
                                <span>Key: ${song.key || '?'}</span>
                                <span>BPM: ${song.bpm || '?'}</span>
                            </div>
                        </div>
                    `;
                    
                    // '업보목록'이 아닌 경우에만 복사 이벤트 리스너 추가
                    if (song.category !== PROTECTED_CATEGORY) {
                        card.addEventListener('click', () => {
                            const textToCopy = `신청 ${song.title}`;
                            copyToClipboard(textToCopy);
                        });
                    } else {
                        card.style.cursor = 'default';
                        card.addEventListener('click', () => {
                            showToast(`'${song.title}' 곡은 업보목록이라 복사할 수 없습니다.`, true);
                        });
                    }
                    
                    songList.appendChild(card);
                });
            };

            // --- 태그 관리 UI 렌더링 함수 ---

            /**
             * '태그 관리' 섹션의 태그 목록을 렌더링합니다. (삭제 버튼 포함)
             * @param {string} type - 'category', 'difficulty', 'priceTag', 'upboType'
             */
            function renderTagManagementList(type) {
                const listContainer = tagManagementLists[type];
                listContainer.innerHTML = ''; // 목록 비우기
                
                let tagsToRender = tagOptions[type];

                // '카테고리' 타입일 경우, '업보목록'을 관리 목록에서 아예 노출하지 않음
                if (type === 'category') {
                    tagsToRender = tagOptions[type].filter(tag => tag !== PROTECTED_CATEGORY);
                }

                tagsToRender.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'flex items-center bg-gray-600 text-gray-200 text-sm font-medium px-2.5 py-1 rounded-full';
                    
                    // '업보목록'은 이미 필터링되었으므로, 관리 목록에 표시되는 모든 태그는 삭제 버튼을 가짐
                    let deleteButtonHtml = `<button data-type="${type}" data-tag="${tag}" class="tag-delete-btn ml-1.5 text-red-400 hover:text-red-300">&times;</button>`;

                    tagEl.innerHTML = `
                        <span>${tag}</span>
                        ${deleteButtonHtml}
                    `;
                    listContainer.appendChild(tagEl);
                });
            }

            /**
             * '노래 등록하기' 폼의 <select> 옵션을 렌더링합니다.
             * @param {string} type - 'category', 'difficulty', 'priceTag', 'upboType'
             */
            function renderSelectOptions(type) {
                const selectEl = formSelects[type];
                const currentVal = selectEl.value; // 현재 선택된 값 유지 (옵션이 삭제되지 않은 경우)
                selectEl.innerHTML = `<option value="">선택하세요...</option>`; // 기본 옵션
                
                tagOptions[type].forEach(tag => {
                    const optionEl = document.createElement('option');
                    optionEl.value = tag;
                    optionEl.textContent = tag;
                    selectEl.appendChild(optionEl);
                });

                // 기존 값 유지 시도
                if (tagOptions[type].includes(currentVal)) {
                    selectEl.value = currentVal;
                }
            }

            /**
             * 모든 태그 관련 UI (관리 목록 + 폼 드롭다운)를 갱신합니다.
             */
            function renderAllTagUIs() {
                renderTagManagementList('category');
                renderTagManagementList('difficulty');
                renderTagManagementList('priceTag');
                renderTagManagementList('upboType'); // [신규]
                renderSelectOptions('category');
                renderSelectOptions('difficulty');
                renderSelectOptions('priceTag');
                renderSelectOptions('upboType'); // [신규]
            }

            // --- 카테고리 필터링 관련 함수 ---

            /**
             * 현재 노래 목록을 'currentCategory' 기준으로 필터링하고 렌더링합니다.
             */
            function filterAndRender() {
                const allSongs = [...existingSongs, ...newSongs];
                let filteredSongs = allSongs;

                if (currentCategory !== '전체') {
                    filteredSongs = allSongs.filter(song => song.category === currentCategory);
                }

                renderSongs(filteredSongs);
            }

            /**
             * 카테고리 필터 버튼을 렌더링합니다.
             */
            function renderFilterButtons() {
                filterButtonsContainer.innerHTML = ''; // 기존 버튼 비우기
                
                // 정렬 규칙 적용: '전체'가 맨 앞, '업보목록'이 맨 뒤
                let categories = [...tagOptions.category];
                const upboIndex = categories.indexOf(PROTECTED_CATEGORY);
                let upbo = [];
                if (upboIndex > -1) {
                    upbo = categories.splice(upboIndex, 1); // '업보목록' 추출
                }
                
                const sortedCategories = ['전체', ...categories, ...upbo]; // '전체' + 나머지 + '업보목록'

                sortedCategories.forEach(category => {
                    const button = document.createElement('button');
                    button.dataset.category = category;
                    button.textContent = category;
                    button.className = 'filter-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-colors';
                    
                    // 활성/비활성 스타일 적용
                    if (category === currentCategory) {
                        button.classList.add('active');
                    } else {
                        button.classList.add('inactive');
                    }
                    
                    filterButtonsContainer.appendChild(button);
                });
            }

            // --- 이벤트 리스너 ---

            // --- 1. HTML 로드 버튼 ---
            loadBtn.addEventListener('click', () => {
                originalHtmlText = htmlInput.value;
                if (!originalHtmlText) {
                    fileInfo.textContent = '❌ HTML 코드를 입력하세요.';
                    fileInfo.className = 'text-sm font-medium text-center mt-3 h-5 text-red-400';
                    return;
                }

                songDataRegex = /(const|let|var)\s+allSongsData\s*=\s*(\[[\s\S]*?\]);/m;
                originalMatch = originalHtmlText.match(songDataRegex);

                if (!originalMatch || !originalMatch[2]) {
                    fileInfo.textContent = '❌ \'allSongsData\' 배열을 찾지 못했습니다.';
                    fileInfo.className = 'text-sm font-medium text-center mt-3 h-5 text-red-400';
                    return;
                }

                try {
                    existingSongs = new Function(`return ${originalMatch[2]}`)();
                    
                    fileInfo.textContent = `✅ ${existingSongs.length}곡의 노래를 로드했습니다.`;
                    fileInfo.className = 'text-sm font-medium text-center mt-3 h-5 text-green-400';
                    
                    htmlInput.rows = 3;
                    htmlInput.disabled = true;
                    loadBtn.disabled = true;

                    tagManagementSection.classList.remove('hidden');
                    editorSection.classList.remove('hidden');
                    songListSection.classList.remove('hidden');

                    renderAllTagUIs();
                    renderFilterButtons(); // 필터 버튼 렌더링
                    filterAndRender(); // 필터링된 목록 렌더링
                    checkGenerateButtonState();

                } catch (error) {
                    console.error('배열 파싱 오류:', error);
                    fileInfo.textContent = '❌ 배열 파싱 중 오류가 발생했습니다. 콘솔을 확인하세요.';
                    fileInfo.className = 'text-sm font-medium text-center mt-3 h-5 text-red-400';
                }
            });

            // --- 2. 태그 관리 (추가/삭제) ---
            
            tagAddButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const type = button.dataset.type;
                    const inputEl = tagInputs[type];
                    const newTag = inputEl.value.trim();
                    
                    // '업보목록' 카테고리 추가 방지
                    if (type === 'category' && newTag === PROTECTED_CATEGORY) {
                        showToast(`'${PROTECTED_CATEGORY}'은(는) 추가할 수 없습니다.`, true);
                        inputEl.value = '';
                        return;
                    }
                    
                    if (newTag && !tagOptions[type].includes(newTag)) {
                        tagOptions[type].push(newTag);
                        renderAllTagUIs();
                        inputEl.value = '';
                        // 카테고리가 변경되었으므로 필터 버튼도 갱신
                        if (type === 'category') {
                            renderFilterButtons();
                        }
                    } else if (!newTag) {
                        showToast('태그 이름을 입력하세요.', true);
                    } else {
                        showToast('이미 존재하는 태그입니다.', true);
                    }
                });
            });

            tagManagementSection.addEventListener('click', (e) => {
                const target = e.target.closest('.tag-delete-btn');
                if (!target) return;

                const type = target.dataset.type;
                const tagToRemove = target.dataset.tag;

                // '업보목록' 카테고리 삭제 방지 (이중 방어)
                if (type === 'category' && tagToRemove === PROTECTED_CATEGORY) {
                    return;
                }

                tagOptions[type] = tagOptions[type].filter(tag => tag !== tagToRemove);
                
                renderAllTagUIs();

                // 카테고리가 변경되었으므로 필터 버튼도 갱신
                if (type === 'category') {
                    // 만약 현재 선택된 카테고리가 삭제되었다면 '전체'로 리셋
                    if (currentCategory === tagToRemove) {
                        currentCategory = '전체';
                    }
                    renderFilterButtons();
                    filterAndRender(); // 노래 목록도 갱신
                }
            });

            // --- 3. 노래 등록 폼 ---
            songForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const newSong = {};
                let isValid = true;
                
                // [수정] 'upboType' 추가
                const songKeys = ['title', 'artist', 'key', 'bpm', 'category', 'difficulty', 'cheeseTag', 'upboType'];
                songKeys.forEach(key => {
                    const inputEl = songForm.querySelector(`[data-key="${key}"]`);
                    if (inputEl) {
                        newSong[key] = inputEl.value || null;
                    }
                });

                if (!newSong.title || !newSong.artist || !newSong.category) {
                    showToast('노래 제목, 아티스트, 카테고리는 필수입니다.', true);
                    isValid = false;
                    return;
                }

                // [신규] '업보목록'일 경우 '업보 태그' 필수 체크
                if (newSong.category === PROTECTED_CATEGORY && !newSong.upboType) {
                    showToast('업보목록 카테고리는 업보 태그가 필수입니다.', true);
                    return;
                }
                
                if (newSong.difficulty === null) delete newSong.difficulty;
                if (newSong.cheeseTag === null) delete newSong.cheeseTag;
                if (newSong.upboType === null) delete newSong.upboType; // [신규]
                if (newSong.key === null) newSong.key = '?';
                if (newSong.bpm === null) newSong.bpm = '?';

                newSongs.push(newSong);
                
                ['title', 'artist', 'key', 'bpm'].forEach(id => {
                    document.getElementById(`song-${id}`).value = '';
                });
                // [수정] 'upboType' 추가
                ['category', 'difficulty', 'priceTag', 'upboType'].forEach(key => {
                    formSelects[key].value = '';
                });

                // [신규] 업보 타입 컨테이너 숨기기
                upboTypeContainer.classList.add('hidden');
                formSelects.upboType.required = false;

                filterAndRender(); // filterAndRender 호출
                checkGenerateButtonState();
            });

            // [신규] 카테고리 변경 시 업보 태그 필드 표시/숨기기
            formSelects.category.addEventListener('change', () => {
                if (formSelects.category.value === PROTECTED_CATEGORY) {
                    upboTypeContainer.classList.remove('hidden');
                    formSelects.upboType.required = true;
                } else {
                    upboTypeContainer.classList.add('hidden');
                    formSelects.upboType.required = false;
                    formSelects.upboType.value = ''; // 숨길 때 값 초기화
                }
            });

            // --- 4. HTML 코드 생성 및 복사 버튼 ---
            generateBtn.addEventListener('click', async () => {
                if (newSongs.length === 0) {
                    showToast('추가된 노래가 없습니다.', true);
                    return;
                }

                generateBtn.disabled = true;
                generateBtn.textContent = '생성 중...';

                try {
                    const allSongs = [...existingSongs, ...newSongs];
                    const indent = originalMatch[1];
                    const newArrayString = JSON.stringify(allSongs, null, 4);
                    const indentedArrayString = newArrayString.split('\n').map((line, index) => {
                        return index === 0 ? line : `${indent}    ${line}`;
                    }).join('\n');
                    const newArrayDeclaration = `${originalMatch[1]}const allSongsData = ${indentedArrayString};`;
                    const updatedHtmlContent = originalHtmlText.replace(
                        originalMatch[0], 
                        newArrayDeclaration
                    );

                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = updatedHtmlContent;
                    tempTextarea.style.position = 'fixed';
                    tempTextarea.style.top = '-9999px';
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    try {
                        const successful = document.execCommand('copy');
                        if(successful) {
                            copyMessage.textContent = '✅ 클립보드에 복사되었습니다!';
                        } else {
                            copyMessage.textContent = '❌ 복사에 실패했습니다.';
                        }
                    } catch (err) {
                        console.error('복사 실패:', err);
                        copyMessage.textContent = '❌ 복사 중 오류가 발생했습니다.';
                    }
                    document.body.removeChild(tempTextarea);
                    
                    setTimeout(() => {
                        copyMessage.textContent = '';
                    }, 2000);

                    newSongs = [];
                    existingSongs = allSongs;
                    originalHtmlText = updatedHtmlContent;
                    originalMatch = originalHtmlText.match(songDataRegex);
                    
                    filterAndRender(); // filterAndRender 호출
                    
                    fileInfo.textContent = `✅ 코드 생성 및 복사 완료! (현재 ${existingSongs.length}곡)`;
                    fileInfo.className = 'text-sm font-medium text-center mt-3 h-5 text-green-400';

                } catch (error) {
                    console.error('HTML 생성 오류:', error);
                    fileInfo.textContent = '❌ 코드 생성 중 오류가 발생했습니다. 콘솔을 확인하세요.';
                    fileInfo.className = 'text-sm font-medium text-center mt-3 h-5 text-red-400';
                }
                
                generateBtn.disabled = false;
                checkGenerateButtonState();
            });

            // --- 카테고리 필터 버튼 클릭 이벤트 (이벤트 위임) ---
            filterButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.filter-btn');
                if (!button) return;

                currentCategory = button.dataset.category; // 현재 카테고리 상태 업데이트

                // 모든 버튼 스타일 초기화
                filterButtonsContainer.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('inactive');
                });
                // 클릭된 버튼만 활성 스타일 적용
                button.classList.remove('inactive');
                button.classList.add('active');

                filterAndRender(); // 목록 갱신
            });


            // --- 생성 버튼 활성화/비활성화 ---
            function checkGenerateButtonState() {
                if (newSongs.length > 0) {
                    generateBtn.classList.remove('hidden');
                    generateBtn.textContent = `HTML 코드 생성 및 복사 (${newSongs.length}곡 추가)`;
                } else {
                    generateBtn.classList.add('hidden');
                    generateBtn.textContent = 'HTML 코드 생성 및 복사';
                }
            }

            checkGenerateButtonState(); // 페이지 초기 로드 시 버튼 상태 체크
        });
    </script>
</body>
</html>
